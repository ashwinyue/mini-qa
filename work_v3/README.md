# Work V3 - æ™ºèƒ½å®¢æœç³»ç»Ÿ

åŸºäº LangChain + LangGraph + FastAPI æ„å»ºçš„ä¼ä¸šçº§æ™ºèƒ½å®¢æœç³»ç»Ÿï¼Œæ”¯æŒå¤šç§Ÿæˆ·ã€RAG çŸ¥è¯†åº“æ£€ç´¢ã€è®¢å•æŸ¥è¯¢ã€å¤š Agent åä½œç­‰åŠŸèƒ½ã€‚

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [API æ–‡æ¡£](#api-æ–‡æ¡£)
- [å¤šç§Ÿæˆ·æ”¯æŒ](#å¤šç§Ÿæˆ·æ”¯æŒ)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ç•Œé¢   â”‚ (React + Vite)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP/REST
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         FastAPI åç«¯æœåŠ¡             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   LangGraph çŠ¶æ€æœºå¼•æ“       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚ Intent â”‚â†’ â”‚   KB   â”‚     â”‚  â”‚
â”‚  â”‚  â”‚ Router â”‚  â”‚ Search â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚ Order  â”‚  â”‚ Direct â”‚     â”‚  â”‚
â”‚  â”‚  â”‚ Query  â”‚  â”‚ Answer â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  FAISS   â”‚  â”‚ SQLite   â”‚       â”‚
â”‚  â”‚ å‘é‡ç´¢å¼•  â”‚  â”‚ è®¢å•æ•°æ®åº“â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DashScope API  â”‚ (é€šä¹‰åƒé—®)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1. æ™ºèƒ½æ„å›¾è¯†åˆ«
- åŸºäºå…³é”®è¯å¿«é€ŸåŒ¹é…
- LLM ç»“æ„åŒ–è·¯ç”±
- æ”¯æŒ 6 ç§æ„å›¾ç±»å‹ï¼šcourseã€presaleã€postsaleã€orderã€humanã€direct

### 2. RAG çŸ¥è¯†åº“æ£€ç´¢
- FAISS å‘é‡ç´¢å¼•
- è¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢
- æ”¯æŒå¤šç§Ÿæˆ·ç‹¬ç«‹çŸ¥è¯†åº“
- è‡ªåŠ¨å¼•ç”¨æ¥æº

### 3. è®¢å•æŸ¥è¯¢
- SQL è‡ªåŠ¨ç”Ÿæˆ
- å‚æ•°åŒ–æŸ¥è¯¢é˜²æ³¨å…¥
- è‡ªç„¶è¯­è¨€è¯æœ¯ç”Ÿæˆ
- æ”¯æŒå¼€è¯¾æ—¶é—´æŸ¥è¯¢

### 4. å¤š Agent åä½œ
- çŠ¶æ€æœºæµç¨‹æ§åˆ¶
- æ¡ä»¶è·¯ç”±åˆ†æ”¯
- æ£€æŸ¥ç‚¹æŒä¹…åŒ–
- ä¼šè¯è®°å¿†ç®¡ç†

### 5. å¤šç§Ÿæˆ·æ”¯æŒ
- ç‹¬ç«‹çŸ¥è¯†åº“
- ç‹¬ç«‹è®¢å•æ•°æ®åº“
- ç§Ÿæˆ·éš”ç¦»
- è¯¾ç¨‹-ç§Ÿæˆ·æ˜ å°„

### 6. å¯è§‚æµ‹æ€§
- è¯·æ±‚é“¾è·¯è¿½è¸ª
- æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡
- ç»“æ„åŒ–æ—¥å¿—
- æ•æ„Ÿä¿¡æ¯è„±æ•

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### åç«¯
- **FastAPI** - Web æ¡†æ¶
- **LangChain** - LLM åº”ç”¨æ¡†æ¶
- **LangGraph** - çŠ¶æ€æœºç¼–æ’
- **FAISS** - å‘é‡æ£€ç´¢
- **SQLite** - è®¢å•æ•°æ®åº“
- **Redis** - ä¼šè¯å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
- **DashScope** - é€šä¹‰åƒé—® API

### å‰ç«¯
- **React** - UI æ¡†æ¶
- **Vite** - æ„å»ºå·¥å…·
- **Ant Design** - ç»„ä»¶åº“
- **Axios** - HTTP å®¢æˆ·ç«¯

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Python 3.9+
- Node.js 16+
- DashScope API Key

### 1. é…ç½®ç¯å¢ƒå˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
DASHSCOPE_API_KEY=your_api_key_here
MODEL_NAME=qwen-turbo
EMBEDDING_MODEL=text-embedding-v4
```

### 2. å®‰è£…ä¾èµ–

```bash
# ä»é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
make install
```

### 3. æ„å»ºç´¢å¼•

```bash
# æ„å»º FAISS å‘é‡ç´¢å¼•
make build-index
```

### 4. å¯åŠ¨æœåŠ¡

```bash
# ä¸€é”®å¯åŠ¨å‰åç«¯
./start.sh
# æˆ–
make start
```

æœåŠ¡å¯åŠ¨åï¼š
- å‰ç«¯ï¼šhttp://localhost:5173
- åç«¯ï¼šhttp://localhost:8000
- å¥åº·æ£€æŸ¥ï¼šhttp://localhost:8000/health

### 5. åœæ­¢æœåŠ¡

```bash
./stop.sh
# æˆ–
make stop
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
work_v3/
â”œâ”€â”€ app.py                    # FastAPI åº”ç”¨å…¥å£
â”œâ”€â”€ graph.py                  # LangGraph çŠ¶æ€æœºå®šä¹‰
â”œâ”€â”€ config.py                 # é…ç½®ç®¡ç†
â”œâ”€â”€ prompts.py                # æç¤ºè¯æ¨¡æ¿
â”œâ”€â”€ tools.py                  # å·¥å…·å‡½æ•°é›†åˆ
â”œâ”€â”€ statee.py                 # çŠ¶æ€å®šä¹‰
â”œâ”€â”€ security_middleware.py    # å®‰å…¨ä¸­é—´ä»¶
â”œâ”€â”€ rag-train.py             # RAG ç´¢å¼•æ„å»ºè„šæœ¬
â”œâ”€â”€ init_orders_db.py        # è®¢å•æ•°æ®åº“åˆå§‹åŒ–
â”œâ”€â”€ backup.py                # å¤‡ä»½å·¥å…·
â”œâ”€â”€ log_push.py              # æ—¥å¿—æ¨é€æœåŠ¡
â”œâ”€â”€ mcp_server.py            # MCP æœåŠ¡å™¨
â”‚
â”œâ”€â”€ datas/                   # çŸ¥è¯†åº“åŸå§‹æ•°æ®
â”‚   â””â”€â”€ data.txt            # è¯¾ç¨‹ FAQ æ–‡æœ¬
â”‚
â”œâ”€â”€ faiss_index/            # FAISS å‘é‡ç´¢å¼•
â”‚   â”œâ”€â”€ index.faiss
â”‚   â””â”€â”€ index.pkl
â”‚
â”œâ”€â”€ db/                     # æ•°æ®åº“æ–‡ä»¶
â”‚   â””â”€â”€ orders.sqlite       # è®¢å•æ•°æ®åº“
â”‚
â”œâ”€â”€ tenants/                # å¤šç§Ÿæˆ·æ•°æ®
â”‚   â”œâ”€â”€ default/           # é»˜è®¤ç§Ÿæˆ·
â”‚   â”‚   â”œâ”€â”€ faiss_index/
â”‚   â”‚   â””â”€â”€ db/
â”‚   â”œâ”€â”€ t1/                # ç§Ÿæˆ· 1
â”‚   â””â”€â”€ t2/                # ç§Ÿæˆ· 2
â”‚
â”œâ”€â”€ logs/                   # æ—¥å¿—æ–‡ä»¶
â”‚   â””â”€â”€ requests.log
â”‚
â”œâ”€â”€ backup/                 # å¤‡ä»½æ–‡ä»¶
â”‚   â””â”€â”€ kb_*.zip
â”‚
â””â”€â”€ tests/                  # æµ‹è¯•æ–‡ä»¶
    â”œâ”€â”€ test_backup.py
    â”œâ”€â”€ test_course_tenant_map.py
    â””â”€â”€ test_tenant_paths.py
```

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

| å˜é‡å | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `DASHSCOPE_API_KEY` | é€šä¹‰åƒé—® API å¯†é’¥ | å¿…å¡« |
| `MODEL_NAME` | ä½¿ç”¨çš„æ¨¡å‹åç§° | qwen-turbo |
| `EMBEDDING_MODEL` | åµŒå…¥æ¨¡å‹åç§° | text-embedding-v4 |
| `KB_INDEX_DIR` | çŸ¥è¯†åº“ç´¢å¼•ç›®å½• | faiss_index |
| `ORDERS_DB_PATH` | è®¢å•æ•°æ®åº“è·¯å¾„ | db/orders.sqlite |
| `TENANTS_BASE_DIR` | ç§Ÿæˆ·æ•°æ®æ ¹ç›®å½• | tenants |
| `REDIS_URL` | Redis è¿æ¥åœ°å€ | redis://127.0.0.1:6379/0 |

### æ”¯æŒçš„æ¨¡å‹

- `qwen-turbo` - å¿«é€Ÿå“åº”ï¼Œé€‚åˆå¯¹è¯
- `qwen-plus` - æ›´å¼ºèƒ½åŠ›ï¼Œé€‚åˆå¤æ‚ä»»åŠ¡
- `qwen-vl-max` - å¤šæ¨¡æ€ï¼Œæ”¯æŒå›¾åƒç†è§£

### åˆ‡æ¢æ¨¡å‹

```bash
# é€šè¿‡ API åˆ‡æ¢
curl -X POST http://localhost:8000/models/switch \
  -H "Content-Type: application/json" \
  -d '{"name":"qwen-plus"}'
```

## ğŸ“¡ API æ–‡æ¡£

### 1. èŠå¤©æ¥å£

**POST** `/chat`

å‘é€ç”¨æˆ·æ¶ˆæ¯å¹¶è·å– AI å›å¤ã€‚

**è¯·æ±‚ä½“ï¼š**
```json
{
  "query": "è¿™é—¨è¯¾ç¨‹é€‚åˆé›¶åŸºç¡€å—ï¼Ÿ",
  "user_id": "user123",
  "thread_id": "session456",
  "images": ["base64_image_data"],
  "audio": "base64_audio_data"
}
```

**å“åº”ï¼š**
```json
{
  "route": "course",
  "answer": "æ ¹æ®å‚è€ƒèµ„æ–™çš„å†…å®¹ï¼Œè¿™é—¨è¯¾ç¨‹ä¸å»ºè®®é›¶åŸºç¡€å­¦å‘˜å‚åŠ ã€‚",
  "sources": [
    {"source": "/path/to/data.txt"}
  ]
}
```

### 2. å¥åº·æ£€æŸ¥

**GET** `/health`

æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡ã€‚

**å“åº”ï¼š**
```json
{
  "model": "qwen-turbo",
  "kb_index": true,
  "orders_db": true,
  "metrics": {
    "overall": {"count": 100, "avg_ms": 1500, "p95_ms": 2000},
    "kb": {"count": 50, "avg_ms": 800},
    "order": {"count": 30, "avg_ms": 1200}
  }
}
```

### 3. æ¬¢è¿è¯­

**GET** `/greet`

è·å–æ¬¢è¿æ¶ˆæ¯å’Œå¿«æ·å…¥å£ã€‚

**å“åº”ï¼š**
```json
{
  "message": "æ‚¨å¥½ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ",
  "options": [
    {"key": "course", "title": "è¯¾ç¨‹å’¨è¯¢"},
    {"key": "order", "title": "è®¢å•æŸ¥è¯¢"},
    {"key": "human", "title": "äººå·¥è½¬æ¥"}
  ]
}
```

### 4. å»ºè®®é—®é¢˜

**GET** `/suggest/{thread_id}`

è·å–åŸºäºä¸Šä¸‹æ–‡çš„å»ºè®®é—®é¢˜ï¼ˆSSE æµå¼ï¼‰ã€‚

**å“åº”ï¼š**
```
event: react_start
data: {"route":"course","suggestions":[],"event":"react_start"}

event: react
data: {"route":"course","suggestions":["é—®é¢˜1","é—®é¢˜2"],"event":"react","final":true}
```

### 5. æ¨¡å‹ç®¡ç†

**GET** `/models/list`

è·å–æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨ã€‚

**POST** `/models/switch`

åˆ‡æ¢å½“å‰ä½¿ç”¨çš„æ¨¡å‹ã€‚

### 6. å‘é‡ç®¡ç†

**POST** `/api/v1/vectors/items`

æ·»åŠ å‘é‡åˆ°çŸ¥è¯†åº“ï¼ˆéœ€è¦ API Keyï¼‰ã€‚

**DELETE** `/api/v1/vectors/items`

ä»çŸ¥è¯†åº“åˆ é™¤å‘é‡ï¼ˆéœ€è¦ API Keyï¼‰ã€‚

### 7. è®¢å•æŸ¥è¯¢

**GET** `/api/orders/{order_id}`

æŸ¥è¯¢è®¢å•è¯¦æƒ…ã€‚

**å“åº”ï¼š**
```json
{
  "order_id": "#20251114001",
  "status": "å·²æ”¯ä»˜",
  "amount": 2999.0,
  "updated_at": "2025-11-14 10:30:00",
  "start_time": "2025-11-20 19:00:00"
}
```

### 8. å¿«æ·æŒ‡ä»¤

åœ¨èŠå¤©ä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ï¼š

- `/help` - æŸ¥çœ‹æ‰€æœ‰å¿«æ·æŒ‡ä»¤
- `/history` - æŸ¥çœ‹æœ€è¿‘ 5 è½®å¯¹è¯
- `/reset` - é‡ç½®å½“å‰ä¼šè¯ä¸Šä¸‹æ–‡

## ğŸ¢ å¤šç§Ÿæˆ·æ”¯æŒ

### ç§Ÿæˆ·é…ç½®

åœ¨ `tenant_courses.json` ä¸­é…ç½®è¯¾ç¨‹ä¸ç§Ÿæˆ·çš„æ˜ å°„ï¼š

```json
{
  "courses": [
    {
      "name": "ai-agent-course",
      "tenant_id": "t1",
      "orders_db": "tenants/t1/db/orders.sqlite",
      "kb_index": "tenants/t1/faiss_index",
      "kb_data": "tenants/t1/datas"
    }
  ]
}
```

### ç§Ÿæˆ·éš”ç¦»

- æ¯ä¸ªç§Ÿæˆ·æœ‰ç‹¬ç«‹çš„çŸ¥è¯†åº“ç´¢å¼•
- æ¯ä¸ªç§Ÿæˆ·æœ‰ç‹¬ç«‹çš„è®¢å•æ•°æ®åº“
- é€šè¿‡ `X-Tenant-ID` è¯·æ±‚å¤´æŒ‡å®šç§Ÿæˆ·

```bash
curl -X POST http://localhost:8000/chat \
  -H "X-Tenant-ID: t1" \
  -H "Content-Type: application/json" \
  -d '{"query":"è¯¾ç¨‹å’¨è¯¢"}'
```

### åˆ›å»ºæ–°ç§Ÿæˆ·

```bash
# 1. åˆ›å»ºç§Ÿæˆ·ç›®å½•
mkdir -p tenants/new_tenant/{faiss_index,db,datas}

# 2. å‡†å¤‡çŸ¥è¯†åº“æ•°æ®
cp your_data.txt tenants/new_tenant/datas/

# 3. æ„å»ºç´¢å¼•
cd work_v3
../venv/bin/python3 rag-train.py --tenant new_tenant

# 4. åˆå§‹åŒ–è®¢å•æ•°æ®åº“
../venv/bin/python3 init_orders_db.py --tenant new_tenant
```

## ğŸ‘¨â€ğŸ’» å¼€å‘æŒ‡å—

### æœ¬åœ°å¼€å‘

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source ../venv/bin/activate

# å¯åŠ¨åç«¯ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
python3 app.py

# å¯åŠ¨å‰ç«¯ï¼ˆæ–°ç»ˆç«¯ï¼‰
cd ../frontend
npm run dev
```

### æ·»åŠ æ–°çš„æ„å›¾ç±»å‹

1. åœ¨ `graph.py` ä¸­çš„ `Route` æ¨¡å‹æ·»åŠ æ–°ç±»å‹
2. åœ¨ `intent_node` ä¸­æ·»åŠ å…³é”®è¯åŒ¹é…è§„åˆ™
3. åˆ›å»ºå¯¹åº”çš„å¤„ç†èŠ‚ç‚¹å‡½æ•°
4. åœ¨ `build_graph` ä¸­æ·»åŠ è·¯ç”±é€»è¾‘

### è‡ªå®šä¹‰æç¤ºè¯

ç¼–è¾‘ `prompts.py` æ–‡ä»¶ï¼š

```python
# æ„å›¾è¯†åˆ«æç¤ºè¯
INTENT_PROMPT = "..."

# RAG å›ç­”æ¨¡æ¿
RAG_PROMPT_TEMPLATE = "..."

# è®¢å•è¯æœ¯æ¨¡æ¿
ORDER_NLG_PROMPT_TEMPLATE = "..."
```

### æ·»åŠ æ–°å·¥å…·

åœ¨ `tools.py` ä¸­æ·»åŠ æ–°å‡½æ•°ï¼š

```python
def your_new_tool(param: str) -> str:
    """å·¥å…·æè¿°"""
    # å®ç°é€»è¾‘
    return result
```

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/test_backup.py

# æŸ¥çœ‹è¦†ç›–ç‡
pytest --cov=. tests/
```

### æ„å»ºç´¢å¼•

```bash
# é»˜è®¤ç§Ÿæˆ·
python3 rag-train.py

# æŒ‡å®šç§Ÿæˆ·
python3 rag-train.py --tenant t1
```

### å¤‡ä»½ä¸æ¢å¤

```bash
# åˆ›å»ºå¤‡ä»½
python3 backup.py

# æ¢å¤å¤‡ä»½
python3 backup.py --restore backup/kb_20251127.zip
```

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæœåŠ¡æ— æ³•å¯åŠ¨

**ç—‡çŠ¶ï¼š** `make start` å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :8000
lsof -i :5173

# å¼ºåˆ¶åœæ­¢
make stop

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/backend.log
```

### é—®é¢˜ 2ï¼šFAISS ç´¢å¼•åŠ è½½å¤±è´¥

**ç—‡çŠ¶ï¼š** `FAISS index load failed`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# é‡æ–°æ„å»ºç´¢å¼•
make build-index

# æ£€æŸ¥ç´¢å¼•æ–‡ä»¶
ls -la work_v3/faiss_index/
ls -la work_v3/tenants/default/faiss_index/
```

### é—®é¢˜ 3ï¼šAPI Key æœªé…ç½®

**ç—‡çŠ¶ï¼š** `Did not find dashscope_api_key`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥ .env æ–‡ä»¶
cat .env

# ç¡®ä¿åŒ…å«
DASHSCOPE_API_KEY=your_key_here
```

### é—®é¢˜ 4ï¼šè·¯ç”±æ€»æ˜¯è¿”å› direct

**ç—‡çŠ¶ï¼š** æ‰€æœ‰é—®é¢˜éƒ½è·¯ç”±åˆ° `direct`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥å…³é”®è¯åŒ¹é…
# ç¡®ä¿é—®é¢˜åŒ…å«ï¼šè¯¾ç¨‹ã€è®¢å•ã€äººå·¥ç­‰å…³é”®è¯

# æ£€æŸ¥ LLM æ˜¯å¦æ­£å¸¸
curl http://localhost:8000/health

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
tail -f logs/backend.log
```

### é—®é¢˜ 5ï¼šçŸ¥è¯†åº“æ£€ç´¢æ— ç»“æœ

**ç—‡çŠ¶ï¼š** `sources` ä¸ºç©º

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥æ•°æ®æ–‡ä»¶
cat work_v3/datas/data.txt

# é‡æ–°æ„å»ºç´¢å¼•
cd work_v3
../venv/bin/python3 rag-train.py

# å¤åˆ¶åˆ°é»˜è®¤ç§Ÿæˆ·
cp faiss_index/* tenants/default/faiss_index/
```

### é—®é¢˜ 6ï¼šå‰ç«¯æ— æ³•è¿æ¥åç«¯

**ç—‡çŠ¶ï¼š** å‰ç«¯æ˜¾ç¤ºè¿æ¥é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥ CORS é…ç½®
# ç¡®ä¿ app.py ä¸­åŒ…å«å‰ç«¯åœ°å€

# æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
curl http://localhost:8000/health

# æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å‘é‡æ£€ç´¢ä¼˜åŒ–

```python
# è°ƒæ•´æ£€ç´¢æ•°é‡
docs = vs.similarity_search(query, k=5)  # é»˜è®¤ k=2

# ä½¿ç”¨æ··åˆæ£€ç´¢
# ç»“åˆå…³é”®è¯å’Œå‘é‡æ£€ç´¢
```

### 2. ç¼“å­˜ç­–ç•¥

```python
# å¯ç”¨ Redis ç¼“å­˜
# åœ¨ .env ä¸­é…ç½®
REDIS_URL=redis://localhost:6379/0
```

### 3. å¹¶å‘æ§åˆ¶

```python
# ä½¿ç”¨å¼‚æ­¥å¤„ç†
async def chat(req: ChatRequest):
    result = await chain.ainvoke(state, cfg)
```

### 4. æ¨¡å‹é€‰æ‹©

- ç®€å•å¯¹è¯ï¼š`qwen-turbo`ï¼ˆå¿«ï¼‰
- å¤æ‚æ¨ç†ï¼š`qwen-plus`ï¼ˆå‡†ï¼‰
- å¤šæ¨¡æ€ï¼š`qwen-vl-max`ï¼ˆå…¨ï¼‰

## ğŸ“ æ—¥å¿—è¯´æ˜

### æ—¥å¿—ä½ç½®

- åº”ç”¨æ—¥å¿—ï¼š`logs/backend.log`
- è¯·æ±‚æ—¥å¿—ï¼š`work_v3/logs/requests.log`
- å‰ç«¯æ—¥å¿—ï¼š`logs/frontend.log`

### æ—¥å¿—æ ¼å¼

```
2025-11-27 10:00:00,123 | INFO | root | Request abc-123 received: POST /chat
2025-11-27 10:00:01,456 | INFO | root | latency route=course cost=1234.56ms
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹
make logs

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œ
tail -n 100 logs/backend.log

# æœç´¢é”™è¯¯
grep ERROR logs/backend.log
```

## ğŸ” å®‰å…¨è¯´æ˜

### 1. æ•æ„Ÿä¿¡æ¯è„±æ•

ç³»ç»Ÿè‡ªåŠ¨è„±æ•ä»¥ä¸‹ä¿¡æ¯ï¼š
- æ‰‹æœºå·
- èº«ä»½è¯å·
- é‚®ç®±åœ°å€
- API Key

### 2. SQL æ³¨å…¥é˜²æŠ¤

ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼š
```python
sql = "SELECT * FROM orders WHERE order_id = %s"
params = [order_id]
```

### 3. API è®¤è¯

å‘é‡ç®¡ç†æ¥å£éœ€è¦ API Keyï¼š
```python
X-API-Key: your_api_key
```

### 4. CORS é…ç½®

ä»…å…è®¸ç‰¹å®šåŸŸåè®¿é—®ï¼š
```python
allow_origins=["http://localhost:5173"]
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [LangChain æ–‡æ¡£](https://python.langchain.com/)
- [LangGraph æ–‡æ¡£](https://langchain-ai.github.io/langgraph/)
- [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [FAISS æ–‡æ¡£](https://github.com/facebookresearch/faiss)
- [é€šä¹‰åƒé—® API](https://help.aliyun.com/zh/dashscope/)

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License

---

**ç»´æŠ¤è€…ï¼š** Your Team  
**æœ€åæ›´æ–°ï¼š** 2025-11-27
