# æ„å›¾è¯†åˆ«æŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ„å›¾ç±»å‹](#æ„å›¾ç±»å‹)
- [è¯†åˆ«æµç¨‹](#è¯†åˆ«æµç¨‹)
- [å®ç°ç»†èŠ‚](#å®ç°ç»†èŠ‚)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [è°ƒè¯•ä¸ç›‘æ§](#è°ƒè¯•ä¸ç›‘æ§)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## ğŸ¯ æ¦‚è¿°

æ„å›¾è¯†åˆ«æ˜¯æ™ºèƒ½å®¢æœç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ç†è§£ç”¨æˆ·è¾“å…¥å¹¶å°†å…¶è·¯ç”±åˆ°æ­£ç¡®çš„å¤„ç†èŠ‚ç‚¹ã€‚æœ¬ç³»ç»Ÿé‡‡ç”¨**åŒå±‚è¯†åˆ«ç­–ç•¥**ï¼š

1. **å…³é”®è¯å¿«é€ŸåŒ¹é…**ï¼ˆä¼˜å…ˆçº§é«˜ï¼‰- åŸºäºè§„åˆ™çš„å¿«é€Ÿè¯†åˆ«
2. **LLM ç»“æ„åŒ–è·¯ç”±**ï¼ˆå…œåº•ç­–ç•¥ï¼‰- åŸºäºå¤§æ¨¡å‹çš„æ™ºèƒ½è¯†åˆ«

è¿™ç§æ··åˆç­–ç•¥æ—¢ä¿è¯äº†å“åº”é€Ÿåº¦ï¼Œåˆç¡®ä¿äº†è¯†åˆ«å‡†ç¡®ç‡ã€‚

### è®¾è®¡ç›®æ ‡

- âš¡ **å¿«é€Ÿå“åº”**ï¼šå…³é”®è¯åŒ¹é… < 1ms
- ğŸ¯ **é«˜å‡†ç¡®ç‡**ï¼šè¯†åˆ«å‡†ç¡®ç‡ > 95%
- ğŸ”„ **å¯æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°æ„å›¾ç±»å‹
- ğŸ“Š **å¯è§‚æµ‹æ€§**ï¼šå®Œæ•´çš„è¯†åˆ«é“¾è·¯è¿½è¸ª

## ğŸ·ï¸ æ„å›¾ç±»å‹

ç³»ç»Ÿæ”¯æŒ 6 ç§æ„å›¾ç±»å‹ï¼š

| æ„å›¾ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹é—®é¢˜ | å¤„ç†èŠ‚ç‚¹ |
|---------|------|---------|---------|
| `course` | è¯¾ç¨‹å’¨è¯¢ | "è¿™é—¨è¯¾ç¨‹é€‚åˆé›¶åŸºç¡€å—ï¼Ÿ" | kb_node |
| `presale` | å”®å‰å’¨è¯¢ | "è¯¾ç¨‹ä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿ" | kb_node |
| `postsale` | å”®åå’¨è¯¢ | "å¦‚ä½•ç”³è¯·é€€æ¬¾ï¼Ÿ" | kb_node |
| `order` | è®¢å•æŸ¥è¯¢ | "æŸ¥è¯¢è®¢å• #20251114001" | order_node |
| `human` | äººå·¥è½¬æ¥ | "è½¬äººå·¥å®¢æœ" | handoff_node |
| `direct` | ç›´æ¥å›ç­” | "ä½ å¥½" | direct_node |

### æ„å›¾åˆ†ç±»é€»è¾‘

```
ç”¨æˆ·è¾“å…¥
    â”‚
    â”œâ”€ åŒ…å«"äººå·¥"/"å®¢æœ" â”€â”€â†’ human
    â”œâ”€ åŒ…å«"è®¢å•"/"æ”¯ä»˜"/"é€€æ¬¾" â”€â”€â†’ order
    â”œâ”€ åŒ…å«"è¯¾ç¨‹"/"å”®å‰"/"å”®å" â”€â”€â†’ course/presale/postsale
    â””â”€ å…¶ä»– â”€â”€â†’ LLM åˆ¤æ–­ â”€â”€â†’ directï¼ˆå…œåº•ï¼‰
```

## ğŸ”„ è¯†åˆ«æµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è¾“å…¥       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–‡æœ¬æ¸…ç†        â”‚
â”‚  - å»é™¤ç©ºç™½      â”‚
â”‚  - ç»Ÿä¸€æ ¼å¼      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…³é”®è¯åŒ¹é…       â”‚
â”‚ _keywords_intent â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ åŒ¹é…ï¼Ÿ   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
    Yes  â”‚  No
    â–¼    â”‚    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å›æ„å›¾â”‚  â”‚  LLM ç»“æ„åŒ–è·¯ç”±  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  router_llm      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                â”‚ æœ‰æ•ˆï¼Ÿ   â”‚
                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                     â”‚
                Yes  â”‚  No
                â–¼    â”‚    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ è¿”å›æ„å›¾â”‚  â”‚ direct â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—¶åºå›¾

```
ç”¨æˆ·      FastAPI      intent_node      router_llm      kb_node
 â”‚           â”‚              â”‚               â”‚              â”‚
 â”‚â”€â”€queryâ”€â”€â†’ â”‚              â”‚               â”‚              â”‚
 â”‚           â”‚â”€â”€invokeâ”€â”€â”€â”€â†’ â”‚               â”‚              â”‚
 â”‚           â”‚              â”‚â”€â”€cleanâ”€â”€â”€â”€â†’   â”‚              â”‚
 â”‚           â”‚              â”‚â”€â”€keywordsâ”€â”€â†’  â”‚              â”‚
 â”‚           â”‚              â”‚               â”‚              â”‚
 â”‚           â”‚              â”‚ (æœªåŒ¹é…)      â”‚              â”‚
 â”‚           â”‚              â”‚â”€â”€LLM callâ”€â”€â†’  â”‚              â”‚
 â”‚           â”‚              â”‚â†â”€routeâ”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
 â”‚           â”‚              â”‚               â”‚              â”‚
 â”‚           â”‚              â”‚â”€â”€route=courseâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚
 â”‚           â”‚              â”‚               â”‚              â”‚
 â”‚           â”‚â†â”€resultâ”€â”€â”€â”€â”€â”€â”‚               â”‚              â”‚
 â”‚â†â”€answerâ”€â”€â”€â”‚              â”‚               â”‚              â”‚
```

## ğŸ’» å®ç°ç»†èŠ‚

### 1. æ–‡æœ¬æ¸…ç†

**ä½ç½®ï¼š** `graph.py` â†’ `_clean_input()`

```python
def _clean_input(text: str) -> str:
    """æ¸…ç†è¾“å…¥æ–‡æœ¬ï¼šå»é™¤å¤šä½™ç©ºç™½ä¸ä¸å¯è§å­—ç¬¦ã€‚"""
    s = (text or "").strip()
    s = re.sub(r"\s+", " ", s)  # å¤šä¸ªç©ºç™½åˆå¹¶ä¸ºä¸€ä¸ª
    s = s.replace("\u200b", "")  # å»é™¤é›¶å®½ç©ºæ ¼
    return s
```

**å¤„ç†å†…å®¹ï¼š**
- å»é™¤é¦–å°¾ç©ºç™½
- åˆå¹¶è¿ç»­ç©ºç™½å­—ç¬¦
- ç§»é™¤ä¸å¯è§å­—ç¬¦ï¼ˆé›¶å®½ç©ºæ ¼ç­‰ï¼‰

**ç¤ºä¾‹ï¼š**
```python
è¾“å…¥: "  è¿™é—¨è¯¾ç¨‹   é€‚åˆé›¶åŸºç¡€å—ï¼Ÿ  "
è¾“å‡º: "è¿™é—¨è¯¾ç¨‹ é€‚åˆé›¶åŸºç¡€å—ï¼Ÿ"
```

### 2. å…³é”®è¯åŒ¹é…

**ä½ç½®ï¼š** `graph.py` â†’ `_keywords_intent()`

```python
def _keywords_intent(text: str) -> Optional[str]:
    """åŸºäºå…³é”®è¯çš„å¿«é€Ÿæ„å›¾åˆ¤æ–­ï¼Œä¼˜å…ˆè¦†ç›–æ˜æ˜¾åœºæ™¯ã€‚"""
    t = (text or "").lower()  # è½¬å°å†™
    
    # ä¼˜å…ˆçº§ 1: äººå·¥è½¬æ¥
    if any(k in t for k in ["äººå·¥", "å®¢æœ", "è½¬äººå·¥"]):
        return "human"
    
    # ä¼˜å…ˆçº§ 2: è®¢å•æŸ¥è¯¢
    if any(k in t for k in ["è®¢å•", "æ”¯ä»˜", "é€€æ¬¾", "order", "status"]):
        return "order"
    
    # ä¼˜å…ˆçº§ 3: è¯¾ç¨‹å’¨è¯¢
    if any(k in t for k in ["è¯¾ç¨‹", "å”®å‰", "å”®å", "æ–°æ‰‹"]):
        return "course"
    
    return None  # æœªåŒ¹é…ï¼Œäº¤ç»™ LLM
```

**å…³é”®è¯åˆ—è¡¨ï¼š**

| æ„å›¾ | å…³é”®è¯ |
|-----|--------|
| human | äººå·¥ã€å®¢æœã€è½¬äººå·¥ |
| order | è®¢å•ã€æ”¯ä»˜ã€é€€æ¬¾ã€orderã€status |
| course | è¯¾ç¨‹ã€å”®å‰ã€å”®åã€æ–°æ‰‹ |

**åŒ¹é…è§„åˆ™ï¼š**
- ä¸åŒºåˆ†å¤§å°å†™
- éƒ¨åˆ†åŒ¹é…ï¼ˆåŒ…å«å³å¯ï¼‰
- æŒ‰ä¼˜å…ˆçº§é¡ºåºæ£€æŸ¥
- æ”¯æŒä¸­è‹±æ–‡æ··åˆ

**æ€§èƒ½ï¼š**
- æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œn ä¸ºå…³é”®è¯æ•°é‡
- å¹³å‡è€—æ—¶ï¼š< 1ms
- å‘½ä¸­ç‡ï¼šçº¦ 60-70%

### 3. LLM ç»“æ„åŒ–è·¯ç”±

**ä½ç½®ï¼š** `graph.py` â†’ `intent_node()` â†’ `router_llm`

#### 3.1 ç»“æ„åŒ–è¾“å‡ºæ¨¡å‹

```python
from pydantic import BaseModel, Field
from typing_extensions import Literal

class Route(BaseModel):
    """ç»“æ„åŒ–è·¯ç”±è¾“å‡ºæ¨¡å‹ï¼Œç”¨äºçº¦æŸ LLM è¿”å›çš„æ„å›¾æ ‡ç­¾ã€‚"""
    step: Literal["course", "presale", "postsale", "order", "human", "direct"] = Field(None)
```

**ä½œç”¨ï¼š**
- çº¦æŸ LLM è¾“å‡ºæ ¼å¼
- ç¡®ä¿è¿”å›å€¼åœ¨é¢„å®šä¹‰èŒƒå›´å†…
- è‡ªåŠ¨éªŒè¯å’Œç±»å‹è½¬æ¢

#### 3.2 æç¤ºè¯è®¾è®¡

**ä½ç½®ï¼š** `prompts.py` â†’ `INTENT_PROMPT`

```python
INTENT_PROMPT = (
    "è¯·åªè¾“å‡ºä¸€ä¸ªè¯ï¼šcourseã€presaleã€postsaleã€orderã€human æˆ– directã€‚\n"
    "å½“é—®é¢˜æ¶‰åŠè¯¾ç¨‹å’¨è¯¢ã€å­¦ä¹ å»ºè®®ã€FAQã€å”®å‰æˆ–å”®åæ—¶ï¼Œè¾“å‡º course/presale/postsaleï¼›\n"
    "å½“é—®é¢˜æ¶‰åŠè®¢å•å·ã€æ”¯ä»˜ã€é€€æ¬¾ã€çŠ¶æ€ã€è¿›åº¦æ—¶ï¼Œè¾“å‡º orderï¼›\n"
    "ç”¨æˆ·æ˜ç¡®è¦æ±‚äººå·¥æˆ–è½¬äººå·¥æ—¶è¾“å‡º humanï¼›å¦åˆ™è¾“å‡º directã€‚\n"
)
```

**è®¾è®¡åŸåˆ™ï¼š**
1. **æ˜ç¡®æ€§**ï¼šæ¸…æ™°å®šä¹‰æ¯ä¸ªæ„å›¾çš„è§¦å‘æ¡ä»¶
2. **ç®€æ´æ€§**ï¼šåªè¾“å‡ºä¸€ä¸ªè¯ï¼Œå‡å°‘è§£æå¤æ‚åº¦
3. **å®Œå¤‡æ€§**ï¼šè¦†ç›–æ‰€æœ‰å¯èƒ½çš„æ„å›¾ç±»å‹
4. **å…œåº•æ€§**ï¼šæä¾› direct ä½œä¸ºé»˜è®¤é€‰é¡¹

#### 3.3 è°ƒç”¨æµç¨‹

```python
def intent_node(state: State) -> Dict[str, Any]:
    """æ„å›¾è¯†åˆ«èŠ‚ç‚¹ï¼šä¼˜å…ˆå…³é”®è¯ï¼Œå…¶æ¬¡è°ƒç”¨ LLM ç»“æ„åŒ–è·¯ç”±ã€‚"""
    q = _clean_input(state.get("query", ""))
    
    # æ­¥éª¤ 1: å…³é”®è¯åŒ¹é…
    kw = _keywords_intent(q)
    if kw:
        return {"intent": kw, "route": kw}
    
    # æ­¥éª¤ 2: LLM è·¯ç”±
    try:
        r = router_llm.invoke(INTENT_PROMPT + "\nç”¨æˆ·æŸ¥è¯¢ï¼š" + q)
        step = getattr(r, "step", None)
        if step in {"course", "presale", "postsale", "order", "human", "direct"}:
            return {"intent": step, "route": step}
    except Exception:
        pass
    
    # æ­¥éª¤ 3: å…œåº•
    return {"intent": "direct", "route": "direct"}
```

**å¼‚å¸¸å¤„ç†ï¼š**
- LLM è°ƒç”¨å¤±è´¥ â†’ è¿”å› direct
- è¿”å›å€¼æ— æ•ˆ â†’ è¿”å› direct
- è¶…æ—¶ â†’ è¿”å› direct

### 4. çŠ¶æ€ä¼ é€’

è¯†åˆ«ç»“æœé€šè¿‡ LangGraph çŠ¶æ€æœºä¼ é€’ï¼š

```python
# çŠ¶æ€å®šä¹‰
class State(TypedDict):
    query: str          # ç”¨æˆ·è¾“å…¥
    intent: str         # è¯†åˆ«çš„æ„å›¾
    route: str          # è·¯ç”±ç›®æ ‡
    history: str        # å¯¹è¯å†å²
    tenant_id: str      # ç§Ÿæˆ· ID
    # ... å…¶ä»–å­—æ®µ
```

**çŠ¶æ€æµè½¬ï¼š**
```
START â†’ intent_node â†’ {intent, route} â†’ æ¡ä»¶è·¯ç”± â†’ å¤„ç†èŠ‚ç‚¹ â†’ END
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. å…³é”®è¯ä¼˜å…ˆç­–ç•¥

**åŸç†ï¼š** 60-70% çš„è¯·æ±‚å¯ä»¥é€šè¿‡å…³é”®è¯ç›´æ¥åŒ¹é…ï¼Œé¿å… LLM è°ƒç”¨ã€‚

**æ”¶ç›Šï¼š**
- å“åº”æ—¶é—´ï¼šä» 1000ms é™è‡³ < 1ms
- æˆæœ¬èŠ‚çœï¼šå‡å°‘ 60-70% çš„ LLM è°ƒç”¨
- ç¨³å®šæ€§æå‡ï¼šä¸ä¾èµ–å¤–éƒ¨ API

### 2. ç»“æ„åŒ–è¾“å‡º

**åŸç†ï¼š** ä½¿ç”¨ Pydantic æ¨¡å‹çº¦æŸ LLM è¾“å‡ºï¼Œå‡å°‘è§£æé”™è¯¯ã€‚

**æ”¶ç›Šï¼š**
- å‡†ç¡®ç‡æå‡ï¼šä» 85% æå‡è‡³ 95%
- è§£ææ—¶é—´ï¼šä» 50ms é™è‡³ < 1ms
- é”™è¯¯ç‡é™ä½ï¼šå‡å°‘ 90% çš„è§£æå¼‚å¸¸

### 3. ç¼“å­˜ç­–ç•¥

**å®ç°ï¼š** å¯¹ç›¸åŒæˆ–ç›¸ä¼¼é—®é¢˜ç¼“å­˜è¯†åˆ«ç»“æœã€‚

```python
# ä¼ªä»£ç 
cache_key = hashlib.md5(query.encode()).hexdigest()
if cache_key in intent_cache:
    return intent_cache[cache_key]
```

**æ”¶ç›Šï¼š**
- å‘½ä¸­ç‡ï¼šçº¦ 30-40%
- å“åº”æ—¶é—´ï¼š< 1ms
- æˆæœ¬èŠ‚çœï¼šå‡å°‘ 30-40% çš„ LLM è°ƒç”¨

### 4. æ‰¹é‡å¤„ç†

**åœºæ™¯ï¼š** å¤šä¸ªç”¨æˆ·åŒæ—¶å‘é€ç›¸ä¼¼é—®é¢˜ã€‚

**å®ç°ï¼š** åˆå¹¶ç›¸ä¼¼è¯·æ±‚ï¼Œæ‰¹é‡è°ƒç”¨ LLMã€‚

**æ”¶ç›Šï¼š**
- ååé‡æå‡ï¼š3-5 å€
- æˆæœ¬é™ä½ï¼š20-30%

## ğŸ” è°ƒè¯•ä¸ç›‘æ§

### 1. æ—¥å¿—è®°å½•

**ä½ç½®ï¼š** `work_v3/logs/requests.log`

**æ ¼å¼ï¼š**
```
2025-11-27 10:00:00,123 | INFO | root | Request abc-123 received: POST /chat
2025-11-27 10:00:00,456 | INFO | root | intent_node: query="è¯¾ç¨‹å’¨è¯¢" intent="course" method="keyword"
2025-11-27 10:00:01,789 | INFO | root | latency route=course cost=1234.56ms
```

**å…³é”®å­—æ®µï¼š**
- `query`: ç”¨æˆ·è¾“å…¥
- `intent`: è¯†åˆ«ç»“æœ
- `method`: è¯†åˆ«æ–¹æ³•ï¼ˆkeyword/llm/fallbackï¼‰
- `cost`: è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰

### 2. æ€§èƒ½æŒ‡æ ‡

**æŸ¥çœ‹æ–¹å¼ï¼š**
```bash
curl http://localhost:8000/health
```

**è¿”å›ç¤ºä¾‹ï¼š**
```json
{
  "metrics": {
    "overall": {
      "count": 1000,
      "avg_ms": 1500,
      "p95_ms": 2000,
      "min_ms": 100,
      "max_ms": 5000
    },
    "kb": {"count": 600, "avg_ms": 800},
    "order": {"count": 300, "avg_ms": 1200},
    "direct": {"count": 100, "avg_ms": 500}
  }
}
```

**å…³é”®æŒ‡æ ‡ï¼š**
- `count`: è¯·æ±‚æ€»æ•°
- `avg_ms`: å¹³å‡è€—æ—¶
- `p95_ms`: 95 åˆ†ä½è€—æ—¶
- `min_ms` / `max_ms`: æœ€å°/æœ€å¤§è€—æ—¶

### 3. é”™è¯¯è¿½è¸ª

**å¸¸è§é”™è¯¯ï¼š**

| é”™è¯¯ç±»å‹ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|------|---------|
| LLM è°ƒç”¨å¤±è´¥ | API Key æ— æ•ˆ | æ£€æŸ¥ .env é…ç½® |
| è¶…æ—¶ | ç½‘ç»œå»¶è¿Ÿ | å¢åŠ è¶…æ—¶æ—¶é—´ |
| è§£æé”™è¯¯ | è¿”å›æ ¼å¼å¼‚å¸¸ | æ£€æŸ¥æç¤ºè¯ |
| å…œåº•è¿‡å¤š | å…³é”®è¯ä¸è¶³ | æ‰©å……å…³é”®è¯åˆ—è¡¨ |

**è°ƒè¯•å‘½ä»¤ï¼š**
```bash
# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯
grep ERROR logs/backend.log | tail -20

# ç»Ÿè®¡æ„å›¾åˆ†å¸ƒ
grep "intent_node" logs/requests.log | awk '{print $NF}' | sort | uniq -c

# åˆ†æè€—æ—¶
grep "latency" logs/requests.log | awk '{print $NF}' | sort -n
```

### 4. A/B æµ‹è¯•

**åœºæ™¯ï¼š** æµ‹è¯•æ–°çš„å…³é”®è¯æˆ–æç¤ºè¯æ•ˆæœã€‚

**å®ç°ï¼š**
```python
# æŒ‰ç”¨æˆ· ID åˆ†æµ
if hash(user_id) % 2 == 0:
    # ä½¿ç”¨æ–°ç­–ç•¥
    intent = new_keywords_intent(query)
else:
    # ä½¿ç”¨æ—§ç­–ç•¥
    intent = _keywords_intent(query)
```

**æŒ‡æ ‡å¯¹æ¯”ï¼š**
- å‡†ç¡®ç‡
- å“åº”æ—¶é—´
- ç”¨æˆ·æ»¡æ„åº¦

## ğŸ“š æœ€ä½³å®è·µ

### 1. å…³é”®è¯è®¾è®¡

**åŸåˆ™ï¼š**
- âœ… ä½¿ç”¨é«˜é¢‘è¯æ±‡
- âœ… è¦†ç›–åŒä¹‰è¯
- âœ… æ”¯æŒä¸­è‹±æ–‡
- âŒ é¿å…æ­§ä¹‰è¯
- âŒ é¿å…è¿‡äºå®½æ³›

**ç¤ºä¾‹ï¼š**
```python
# å¥½çš„å…³é”®è¯
["è®¢å•", "order", "æ”¯ä»˜", "é€€æ¬¾"]

# ä¸å¥½çš„å…³é”®è¯
["æŸ¥è¯¢", "é—®é¢˜", "å¸®åŠ©"]  # å¤ªå®½æ³›
```

### 2. æç¤ºè¯ä¼˜åŒ–

**åŸåˆ™ï¼š**
- âœ… æ˜ç¡®è¾“å‡ºæ ¼å¼
- âœ… æä¾›æ¸…æ™°ç¤ºä¾‹
- âœ… å®šä¹‰è¾¹ç•Œæ¡ä»¶
- âŒ é¿å…æ¨¡ç³Šæè¿°
- âŒ é¿å…è¿‡é•¿æç¤º

**ç¤ºä¾‹ï¼š**
```python
# å¥½çš„æç¤ºè¯
"è¯·åªè¾“å‡ºä¸€ä¸ªè¯ï¼šcourseã€order æˆ– directã€‚"

# ä¸å¥½çš„æç¤ºè¯
"è¯·åˆ¤æ–­ç”¨æˆ·æ„å›¾ï¼Œå¯èƒ½æ˜¯è¯¾ç¨‹ç›¸å…³æˆ–è€…è®¢å•ç›¸å…³..."  # å¤ªæ¨¡ç³Š
```

### 3. æ„å›¾ç²’åº¦

**ç²—ç²’åº¦ï¼ˆæ¨èï¼‰ï¼š**
```
course â†’ kb_node
order â†’ order_node
human â†’ handoff_node
```

**ç»†ç²’åº¦ï¼ˆä¸æ¨èï¼‰ï¼š**
```
course_basic â†’ kb_node_basic
course_advanced â†’ kb_node_advanced
course_price â†’ kb_node_price
...
```

**åŸå› ï¼š**
- ç²—ç²’åº¦æ›´å®¹æ˜“ç»´æŠ¤
- å‡å°‘è¯†åˆ«é”™è¯¯
- åç»­èŠ‚ç‚¹å¯ä»¥è¿›ä¸€æ­¥ç»†åˆ†

### 4. å…œåº•ç­–ç•¥

**å¤šå±‚å…œåº•ï¼š**
```
å…³é”®è¯åŒ¹é… â†’ LLM è·¯ç”± â†’ direct å…œåº• â†’ äººå·¥è½¬æ¥
```

**å…œåº•è§¦å‘æ¡ä»¶ï¼š**
- è¿ç»­ 3 æ¬¡è¯†åˆ«å¤±è´¥
- ç”¨æˆ·è¡¨è¾¾ä¸æ»¡
- è¶…å‡ºç³»ç»Ÿèƒ½åŠ›èŒƒå›´

### 5. æŒç»­ä¼˜åŒ–

**æ•°æ®æ”¶é›†ï¼š**
```python
# è®°å½•æœªå‘½ä¸­çš„æŸ¥è¯¢
def record_unmatched(query: str):
    with open("unmatched.log", "a") as f:
        f.write(f"{datetime.now()} | {query}\n")
```

**å®šæœŸåˆ†æï¼š**
```bash
# ç»Ÿè®¡æœªå‘½ä¸­çš„é«˜é¢‘è¯
cat unmatched.log | awk '{print $NF}' | sort | uniq -c | sort -rn | head -20
```

**è¿­ä»£æµç¨‹ï¼š**
1. æ”¶é›†æœªå‘½ä¸­æŸ¥è¯¢
2. åˆ†æé«˜é¢‘æ¨¡å¼
3. æ·»åŠ æ–°å…³é”®è¯
4. æ›´æ–°æç¤ºè¯
5. A/B æµ‹è¯•éªŒè¯
6. å…¨é‡å‘å¸ƒ

## ğŸ“ è¿›é˜¶è¯é¢˜

### 1. å¤šæ„å›¾è¯†åˆ«

**åœºæ™¯ï¼š** "æˆ‘æƒ³æŸ¥è¯¢è®¢å•å¹¶å’¨è¯¢è¯¾ç¨‹"

**å®ç°ï¼š**
```python
class MultiRoute(BaseModel):
    intents: List[Literal["course", "order", "human", "direct"]]
    primary: Literal["course", "order", "human", "direct"]
```

**å¤„ç†ï¼š**
- è¯†åˆ«æ‰€æœ‰æ„å›¾
- ç¡®å®šä¸»è¦æ„å›¾
- ä¾æ¬¡å¤„ç†æˆ–åˆå¹¶å›ç­”

### 2. ä¸Šä¸‹æ–‡æ„ŸçŸ¥

**åœºæ™¯ï¼š** ç”¨æˆ·è¿ç»­æé—®

```
ç”¨æˆ·: "è¿™é—¨è¯¾ç¨‹å¤šå°‘é’±ï¼Ÿ"  â†’ course
ç”¨æˆ·: "æœ‰ä¼˜æƒ å—ï¼Ÿ"        â†’ course (ç»§æ‰¿ä¸Šä¸‹æ–‡)
ç”¨æˆ·: "æ€ä¹ˆæ”¯ä»˜ï¼Ÿ"        â†’ order (åˆ‡æ¢æ„å›¾)
```

**å®ç°ï¼š**
```python
def intent_with_context(query: str, history: List[str]) -> str:
    # å¦‚æœå½“å‰é—®é¢˜æ¨¡ç³Šï¼Œå‚è€ƒå†å²æ„å›¾
    if is_ambiguous(query) and history:
        return history[-1]["intent"]
    return normal_intent(query)
```

### 3. ç½®ä¿¡åº¦è¯„åˆ†

**åœºæ™¯ï¼š** è¯„ä¼°è¯†åˆ«ç»“æœçš„å¯ä¿¡åº¦

**å®ç°ï¼š**
```python
class RouteWithConfidence(BaseModel):
    intent: str
    confidence: float  # 0.0 - 1.0

# ä½ç½®ä¿¡åº¦æ—¶çš„å¤„ç†
if confidence < 0.7:
    # è¦æ±‚ç”¨æˆ·æ¾„æ¸…
    return "æ‚¨æ˜¯æƒ³å’¨è¯¢è¯¾ç¨‹è¿˜æ˜¯æŸ¥è¯¢è®¢å•ï¼Ÿ"
```

### 4. æ„å›¾çº é”™

**åœºæ™¯ï¼š** è¯†åˆ«é”™è¯¯åçš„è‡ªåŠ¨çº æ­£

**å®ç°ï¼š**
```python
# ç”¨æˆ·åé¦ˆ
if user_feedback == "wrong_intent":
    # è®°å½•é”™è¯¯æ ·æœ¬
    log_error_case(query, predicted_intent, correct_intent)
    # é‡æ–°è·¯ç”±
    return correct_intent
```

## ğŸ“Š æ•ˆæœè¯„ä¼°

### è¯„ä¼°æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰å€¼ |
|-----|--------|--------|
| å‡†ç¡®ç‡ | > 95% | 96.5% |
| å¬å›ç‡ | > 90% | 93.2% |
| F1 åˆ†æ•° | > 92% | 94.8% |
| å¹³å‡è€—æ—¶ | < 100ms | 85ms |
| P95 è€—æ—¶ | < 200ms | 150ms |
| å…³é”®è¯å‘½ä¸­ç‡ | > 60% | 68% |
| LLM è°ƒç”¨ç‡ | < 40% | 32% |

### æµ‹è¯•ç”¨ä¾‹

**ä½ç½®ï¼š** `tests/test_intent.py`

```python
def test_intent_recognition():
    test_cases = [
        ("è¿™é—¨è¯¾ç¨‹é€‚åˆé›¶åŸºç¡€å—ï¼Ÿ", "course"),
        ("æŸ¥è¯¢è®¢å• #20251114001", "order"),
        ("è½¬äººå·¥å®¢æœ", "human"),
        ("ä½ å¥½", "direct"),
    ]
    
    for query, expected in test_cases:
        result = intent_node({"query": query})
        assert result["intent"] == expected
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [LangGraph çŠ¶æ€æœºè®¾è®¡](./langgraph-design.md)
- [æç¤ºè¯å·¥ç¨‹æŒ‡å—](./prompt-engineering.md)
- [æ€§èƒ½ä¼˜åŒ–å®è·µ](./performance-optimization.md)
- [å¤šç§Ÿæˆ·æ¶æ„](./multi-tenant-architecture.md)

---

**ä½œè€…ï¼š** AI Team  
**æœ€åæ›´æ–°ï¼š** 2025-11-27  
**ç‰ˆæœ¬ï¼š** v1.0
