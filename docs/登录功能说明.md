# 登录功能说明

## 功能概述

系统已添加完整的用户认证功能，包括：
- 用户登录
- 用户注册
- Token 认证
- 自动登出
- 路由保护

## 测试账号

### 管理员账号
- 用户名：`admin`
- 密码：`admin123`
- 角色：管理员

### 演示账号
- 用户名：`demo`
- 密码：`demo123`
- 角色：普通用户

## 访问地址

- 登录页面：http://localhost:5174/login
- 主页面：http://localhost:5174/ （需要登录）

## API 接口

### 1. 登录接口

**请求：**
```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'
```

**响应：**
```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "token": "xxx",
    "user": {
      "username": "admin",
      "nickname": "管理员",
      "role": "admin",
      "email": "admin@example.com"
    },
    "expiresIn": 604800
  }
}
```

### 2. 注册接口

**请求：**
```bash
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "password": "password123",
    "nickname": "新用户",
    "email": "newuser@example.com"
  }'
```

**响应：**
```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "message": "注册成功"
  }
}
```

### 3. 获取当前用户信息

**请求：**
```bash
curl -X GET http://localhost:8000/api/auth/me \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**响应：**
```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "username": "admin",
    "nickname": "管理员",
    "role": "admin",
    "email": "admin@example.com"
  }
}
```

### 4. 登出接口

**请求：**
```bash
curl -X POST http://localhost:8000/api/auth/logout \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**响应：**
```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "message": "登出成功"
  }
}
```

## 前端实现

### 1. 登录页面

位置：`frontend/src/pages/Login.tsx`

特性：
- 登录/注册切换
- 表单验证
- 错误提示
- 演示账号提示
- 响应式设计

### 2. 认证服务

位置：`frontend/src/services/authService.ts`

功能：
- Token 管理（localStorage）
- 用户信息缓存
- 自动登出
- 认证状态检查

### 3. 路由保护

位置：`frontend/src/components/common/PrivateRoute.tsx`

功能：
- 检查登录状态
- 自动跳转到登录页
- Token 验证
- 加载状态显示

### 4. API 拦截器

位置：`frontend/src/services/api.ts`

功能：
- 自动添加 Authorization header
- 401 错误自动登出
- Token 过期处理

## 使用流程

### 1. 首次访问

1. 访问 http://localhost:5174
2. 自动跳转到 http://localhost:5174/login
3. 输入用户名和密码
4. 点击"登录"按钮
5. 登录成功后跳转到主页面

### 2. 已登录用户

1. Token 保存在 localStorage
2. 刷新页面自动验证 Token
3. Token 有效则直接进入主页面
4. Token 无效则跳转到登录页

### 3. 注册新用户

1. 在登录页面切换到"注册"标签
2. 填写用户名、昵称、密码
3. 可选填写邮箱
4. 点击"注册"按钮
5. 注册成功后切换到登录标签
6. 使用新账号登录

### 4. 登出

1. 点击右上角用户名
2. 选择"退出登录"
3. 清除本地 Token
4. 跳转到登录页

## 安全特性

### 1. 密码加密

- 使用 SHA-256 哈希
- 密码不以明文存储
- 传输时使用 HTTPS（生产环境）

### 2. Token 管理

- 随机生成 32 字节 Token
- Token 有效期 7 天
- 自动清理过期 Token
- 支持主动撤销

### 3. 前端保护

- 路由级别保护
- API 请求自动携带 Token
- 401 错误自动登出
- XSS 防护（React 自带）

### 4. 后端保护

- Token 验证中间件
- 请求日志记录
- 敏感信息脱敏
- CORS 配置

## 开发建议

### 1. 生产环境改进

```python
# work_v3/auth.py

# 使用数据库存储用户
import sqlite3

# 使用 Redis 存储 Token
import redis

# 使用更安全的密码哈希
import bcrypt

# 添加密码强度验证
import re

# 添加登录失败次数限制
from collections import defaultdict
```

### 2. 前端改进

```typescript
// 添加记住我功能
localStorage.setItem('remember_me', 'true');

// 添加自动刷新 Token
setInterval(refreshToken, 3600000); // 每小时刷新

// 添加多设备登录管理
const devices = await getLoginDevices();

// 添加登录历史记录
const history = await getLoginHistory();
```

### 3. 功能扩展

- [ ] 忘记密码
- [ ] 邮箱验证
- [ ] 手机验证码登录
- [ ] 第三方登录（微信、GitHub）
- [ ] 双因素认证（2FA）
- [ ] 单点登录（SSO）
- [ ] 权限管理（RBAC）
- [ ] 用户资料编辑

## 故障排查

### 问题 1：登录按钮点击无反应

**原因：** API 服务未导出通用方法

**解决：** 已在 `api.ts` 中添加 `get`、`post`、`put`、`delete` 方法

### 问题 2：登录后仍跳转到登录页

**原因：** Token 未正确保存或验证失败

**检查：**
```javascript
// 浏览器控制台
localStorage.getItem('auth_token')
localStorage.getItem('user_info')
```

### 问题 3：401 错误

**原因：** Token 过期或无效

**解决：** 重新登录获取新 Token

### 问题 4：CORS 错误

**原因：** 后端 CORS 配置不正确

**检查：** `work_v3/app.py` 中的 CORS 配置

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5174"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

## 测试命令

```bash
# 测试登录
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 测试注册
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test123","nickname":"测试用户"}'

# 测试获取用户信息（需要替换 TOKEN）
curl -X GET http://localhost:8000/api/auth/me \
  -H "Authorization: Bearer YOUR_TOKEN"

# 测试登出
curl -X POST http://localhost:8000/api/auth/logout \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 注意事项

1. **开发环境**：当前使用内存存储，重启后数据丢失
2. **生产环境**：必须使用数据库和 Redis
3. **HTTPS**：生产环境必须使用 HTTPS
4. **密码策略**：建议添加密码强度要求
5. **Token 刷新**：建议实现 Token 自动刷新机制
